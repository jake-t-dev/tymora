name: Build and Deploy to GCE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  REPOSITORY: tymora-repo
  IMAGE: tymora-bot
  GCE_INSTANCE: tymora-instance 
  GCE_ZONE: us-central1-a

jobs:
  build-and-deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: 'Configure Docker for Artifact Registry'
      run: |-
        gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

    - name: Build and Push Container
      run: |-
        DOCKER_TAG="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ github.sha }}"
        docker build -t "$DOCKER_TAG" .
        docker push "$DOCKER_TAG"

    - name: Deploy to GCE (Container-Optimized OS)
      run: |-
        IMAGE_URL="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ github.sha }}"
        
        if gcloud compute instances describe ${{ env.GCE_INSTANCE }} --zone ${{ env.GCE_ZONE }} > /dev/null 2>&1; then
          echo "Instance exists, updating container..."
          gcloud compute instances update-container ${{ env.GCE_INSTANCE }} \
            --zone ${{ env.GCE_ZONE }} \
            --container-image "$IMAGE_URL"
        else
          echo "Instance does not exist, creating free-tier e2-micro..."
          gcloud compute instances create-with-container ${{ env.GCE_INSTANCE }} \
            --zone ${{ env.GCE_ZONE }} \
            --machine-type=e2-micro \
            --container-image "$IMAGE_URL" \
            --scopes=https://www.googleapis.com/auth/cloud-platform
        fi
